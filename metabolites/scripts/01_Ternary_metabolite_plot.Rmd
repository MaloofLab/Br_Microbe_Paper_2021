---
title: "Ternary plot for metabolites"
output: html_document
---

```{r}
if(!"ggtern" %in% installed.packages(fields="Package"))
  install.packages("ggtern")
```

```{r}
library(tidyverse)
library(broom)
library(ggtern)
library(lmerTest)
```

## get and wrangle metabolite data
```{r}
met_raw <-read_csv("../input/metabolites_set1.csv")
met <- met_raw %>% 
  mutate(sampleID=str_c("wyo", genotype, pot, sep="_")) %>%
  mutate(trt=ifelse(is.na(autoclave), "BLANK", autoclave)) %>%
  select(sampleID, pot, genotype, tissue, trt, sample_mass = `sample_mass mg`, !submission_number:concatenate)  %>%
  
  #make long
  pivot_longer(!sampleID:sample_mass, names_to = "metabolite", values_to = "met_amount") %>%
  
  #adjust by sample mass
  mutate(met_per_mg=met_amount/sample_mass) %>%
  
  # got normalized and raw measurements in same column
  
  pivot_longer(c(met_amount, met_per_mg), names_to = "type", values_to = "amount") %>%
  mutate(type=ifelse(type=="met_amount", "raw", "normalized")) %>%
  
  arrange(metabolite, type, tissue, trt, genotype)

met %>% head 
```
### Add block info

```{r}
plantinfo <- readxl::read_excel("../../plant/input/exp1_leaf_ln_data.xlsx", sheet = 2) %>%
  select(pot, block) %>%
  mutate(block=str_c("B", block)) # make it character to ensure used correctly.
plantinfo
```

```{r}
met <- met %>% inner_join(plantinfo) %>%
  select(sampleID, block, everything())
met %>% head
```

## find sig metabolites

Use lmer so that we can include block.  A fair number of metabolites give a boundary / singlular warning.  In that case it is because the block variance is estimated at 0, and in those cases lmer and lm give the same results.  So while it is a bit unsettling, I will leave that as is.

Also, storing all of the lmer results in the tibble bogs things down, so I wil store anova results and then re-run metabolites of interest.
```{r}
lm.anova.pvals <- function(x) {
  lm(amount ~ trt * genotype, data=x) %>%
    aov() %>%
    summary() %>%
    magrittr::extract2(1) %>%
    magrittr::extract(1:3, "Pr(>F)", drop=FALSE) %>%
    t() %>%
    as_tibble() %>%
    rename_with( ~ {str_remove_all(.x, " ") %>% 
        str_c( "_lm.pval")} )
}

lmer.anova.pvals <- function(x) {
  lmer(amount ~ trt * genotype + (1|block), data=x) %>%
    anova() %>%
    t() %>%
    magrittr::extract("Pr(>F)",, drop=FALSE) %>%
    as_tibble() %>%
    rename_with( ~ str_c(.x, "_lmer.pval"))
}

met_lm <- met %>%
  mutate(trt = factor(trt, levels = c("live", "dead", "BLANK"))) %>% # setting live to be ref will make some of the filtering easier
  group_by(metabolite, tissue, type) %>%
  nest() 

system.time(
  met_lm <- met_lm %>% mutate(lm=map(data, lm.anova.pvals), 
                              lmer=map(data, lmer.anova.pvals)) %>%
    unnest(c(lm,lmer)) %>%
    
    group_by(tissue, type) %>%
    mutate(lmer.trt.fdr=p.adjust(trt_lmer.pval, method = "fdr"),
           lmer.interaction.fdr=p.adjust(`trt:genotype_lmer.pval`, method="fdr")) %>%
    
    # FDR only on named metabolites
    mutate(named = str_detect(metabolite, pattern="^[0-9]+$", negate=TRUE)) %>%
    group_by(tissue, type, named) %>%
    mutate(named.lmer.trt.fdr=ifelse(named, p.adjust(trt_lmer.pval, method = "fdr"), NA),
           named.lmer.interaction.fdr=ifelse(named, p.adjust(`trt:genotype_lmer.pval`, method="fdr"), NA)) %>%
    ungroup()
)

met_lm[1:20,]
```

```{r}
met_lm %>% ungroup() %>%
  summarize(across(ends_with("pval"),.fns = ~ sum(.x < 0.05)))

met_lm %>% group_by(tissue, type) %>%
  summarize(across(ends_with("fdr"),.fns = ~ sum(.x < 0.1, na.rm = TRUE)))

sum(met_lm$trt_lm.pval < 0.05 & met_lm$trt_lmer.pval >= 0.05)
sum(met_lm$`trt:genotype_lm.pval` < 0.05 & met_lm$`trt:genotype_lmer.pval` >= 0.05)

```
```{r}
met_lm %>% filter(named.lmer.trt.fdr < 0.1)
```



So the lmer is a bit more sensitive and there are only 2 that lm picks up and lmer doesn't.  go with lmer.
Filter to keep metabolites significant for trt or trt:genotype interaction
```{r}

met_lm_filtered <- met_lm %>%
  select(tissue, metabolite, type, data, contains("lmer")) %>%
  filter(             trt_lmer.pval < 0.05 | 
                        `trt:genotype_lmer.pval` < 0.05)

met_lm_filtered[1:20,]
```

Now: rerun lmer on these 338 and then pull out fitted values

```{r}
get_coef_pvals <- function(x) {
  x %>% broom.mixed::tidy() %>%
  filter(term %in% c("trtdead", "trtBLANK")) %>%
  select(term, p.value) %>%
  column_to_rownames("term") %>%
  t() %>%
  as_tibble() %>%
  rename_with( ~ str_c( .x, "_pval"))
}

newdata <- expand.grid(genotype=c("R500", "FPsc"), trt=c("live", "dead", "BLANK")) # data frame for predictions

met_lm_fitted <- met_lm_filtered %>%
  mutate(lmer = map(data, ~ lmer(amount ~ genotype*trt + (1|block), data = .x)),
         fitted = map(lmer, ~ cbind(newdata, estimate=predict(.x, re.form = ~0, newdata=newdata))),
         coef.pval = map(lmer, get_coef_pvals)
                      ) %>%
  select(-data, -lmer) %>%
  unnest(c(fitted, coef.pval))

met_lm_fitted[1:12,]
```


## On to ternary plot

### calculate proportion of total

```{r}
met_plot <- met_lm_fitted %>%
  group_by(metabolite, genotype, tissue, type) %>%
  
  #proportion of total
  mutate(prop_total = estimate /sum(estimate)) %>%
  
  #reformat
  pivot_wider(id_cols = c(genotype, tissue, metabolite, type, trtdead_pval, trtBLANK_pval, named.lmer.trt.fdr), 
              names_from = trt, 
              values_from = prop_total) %>%
  arrange(metabolite, type, tissue, genotype) %>%
  mutate(sigboth = trtdead_pval < 0.1 & trtBLANK_pval < 0.1,
         sigfdr = ifelse(is.na(named.lmer.trt.fdr), FALSE, named.lmer.trt.fdr < 0.1) )

met_plot %>% head(20)
```

```{r, fig.width=6.5, fig.height=6.5}
met_plot %>% filter(type=="raw") %>%
  select(tissue, 
         genotype, 
         sigboth,
         sigfdr,
         L=live,
         D=dead,
         B=BLANK) %>%
  arrange(sigfdr, sigboth) %>%
  
  ggtern(aes(B, L, D)) +
  geom_point(aes(color=sigboth, shape=sigfdr, alpha=sigfdr)) +
  scale_color_manual(values=c("TRUE" = "red", "FALSE" = "black"), guide="none") +
  scale_shape_manual(values=c("TRUE" = 17, "FALSE" = 1), guide = "none") +
  scale_alpha_manual(values=c("TRUE" = 1, "FALSE" = 0.4), guide = "none") +
  facet_grid(tissue ~ genotype) + ggtitle("Not normalized") + theme_bw() 
ggsave("../../_Paper_Figures/Figure_5.png", height = 6.5, width = 6.5)
ggsave("/Volumes/GoogleDrive/Shared drives/BrassicaMicrobeRNAseq/Figs and Tables/Figure_5.png", height = 6.5, width = 6.5)

```

```{r, fig.width=6.5, fig.height=6.5}
met_plot %>% filter(type=="normalized") %>%
  select(tissue, 
         genotype, 
         sigboth,
         L=live,
         D=dead,
         B=BLANK) %>%
  arrange(sigboth) %>%
  
  ggtern(aes(B, L, D)) +
  geom_point(alpha=.4, aes(color=sigboth)) +
  scale_color_manual(values=c("TRUE" = "red", "FALSE" = "black"), guide="none") +
  facet_grid(tissue ~ genotype) + ggtitle("Normalized") + theme_bw() 
ggsave("../../_Paper_Figures/Figure_S5.png", height = 6.5, width = 6.5)
ggsave("/Volumes/GoogleDrive/Shared drives/BrassicaMicrobeRNAseq/Figs and Tables/Figure_S5.png", height = 6.5, width = 6.5)

```