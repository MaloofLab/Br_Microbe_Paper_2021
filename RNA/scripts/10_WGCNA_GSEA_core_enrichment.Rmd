---
title: "10_WGCNA_GSEA_core_enrichment"
author: "Kazu"
date: "12/2/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---
# History
* Extract core enrichment genes (030721)

# To Do

```{r setup}
rm(list=ls())
knitr::opts_chunk$set(error = TRUE,warning=FALSE)
library(tidyverse);library(readr);library(readxl);library(openxlsx)
# The following setting is important for WGCNA, do not omit.
 options(stringsAsFactors = FALSE)
# install.packages(c("dynamicTreeCut", "cluster", "flashClust", "Hmisc", "reshape", "foreach", "doParallel") ) 
library(WGCNA);library(flashClust) # for WGCNA in Whitney
#allowWGCNAThreads(nThreads = NULL) # for Whitney
#enableWGCNAThreads(4) # for Whitney
library(scales) # for muted function
library(ggdendro) # for dendrogram
library(cowplot)
library(ggnewscale)

```

# annotation file for v3.0annotation
```{r}
# annotation file for v3.0annotation
Br.v3.0.At.BLAST <- read_csv(file.path("annotation","output","Brapa_v3.0_annotated.csv")) 
# This annotation is redundant with name (Br grene). Eg 
Br.v3.0.At.BLAST %>% filter(name=="BraA01g040570.3C")
# reduce the redundancy (112418)
Br.v3.0anno.At.BLAST.highscore <- Br.v3.0.At.BLAST %>% group_by(name) %>% arrange(desc(score)) %>% slice(1)
```

# Julin's Machine Learning selected modules
```{r eval=FALSE}
# reading Julin's results of penalized regression (see slide)
ElasticNet0.5_LOO_prop_var <- read_csv(file.path("plant","output","ElasticNet0.5_LOO_prop_var.csv"))
ElasticNet0.5_LOO_prop_var <- ElasticNet0.5_LOO_prop_var %>% mutate(J.module=str_remove(ME,"ME")) %>% separate(J.module,into=c("module","tissue")) %>% mutate(module=str_to_upper(module)) %>% unite(tissue.module,c("tissue","module"),sep=".") 
```

# reading GSEA results (all WGCNA modules)
# GSEA analysis with WGCNA modules
## read reports 
## function for oct30 reports copied from "10_WGCNA_including_R500.Rmd"
```{r eval=FALSE}
read.gsea_report_files_WGCNA <- function(gsea_report_path,GSEA.FDR.cutoff,tp=c("resid","removeblock"),data="exp_gt_block") {
# open xsl files and save as csvs
# gsea_report
gsea_report_files <- list.files(path=gsea_report_path,full.names=FALSE,include.dirs = FALSE,recursive=TRUE, pattern="(gsea_report_for)([[:print:]]+)(\\.xls)")
# ifelse(setCutoff=="Total", x <- "Total",if(setCutoff<10) {x <-  str_c("In0",setCutoff)} else {x <- str_c("In",setCutoff)})

# gsea_report_files <- gsea_report_files[str_detect(gsea_report_files,x)]
# print(str_c(x,"orless"))

gsea_report_files
# gsea_report (full name)
gsea_report_files2 <- list.files(path=gsea_report_path,full.names=TRUE,recursive=TRUE, pattern="(gsea_report_for)([[:print:]]+)(\\.xls)")
#gsea_report_files2 <- gsea_report_files2[str_detect(gsea_report_files2,x)] 
#gsea_report_files2
# read xls file (file name is "xls", actually tsv. That is why read_xls did not work)
GSEA_reports<-lapply(gsea_report_files2, function(x) read_tsv(file=file.path(x)))
# name
names(GSEA_reports) <- gsea_report_files
  gsub(".xls","",gsub("([[:print:]]+)(/)([[:print:]]+)","\\3",gsea_report_files))
# convert list into one data.frame
GSEA_reports.DF <- GSEA_reports %>% enframe(name="report") %>% unnest(value)
#GSEA_reports.DF %>% View()
# filter only significnt `FDR q-val` (GSEA.FDR.cutoff)
GSEA_reports.DF <- GSEA_reports.DF #%>% filter(`FDR q-val`< GSEA.FDR.cutoff)
# 
GSEA_reports.DF <- GSEA_reports.DF %>% separate(report,into=c("report2","report3"),sep="/") %>% mutate(report2=str_replace(report2,"remove.block","removeblock")) %>% separate(report2,into=c("exp","type","type2","tissue","categories"),sep="\\.",fill="left",extra="drop") 
# GSEA_reports.DF <- GSEA_reports.DF %>% filter(type2==data) # works?
#GSEA_reports.DF$LorD <- gsub("(gsea_report_for_)(0|1)([[:print:]]+)","\\2",GSEA_reports.DF$report3)
#GSEA_reports.DF <- GSEA_reports.DF %>% mutate(LorD=ifelse(LorD==0,"Live","Dead"))
GSEA_reports.DF %>% View()
ifelse(dim(GSEA_reports.DF)[1]==0,print("no significnat categories"),return(GSEA_reports.DF))
}
```


# Finding soil treatment responsive genes in WGCNA module (significant one) for GSEA_reports.DF.MLselected
```{r}
GSEA_reports.DF.MLselected <- read_csv(file.path("RNA","output","GSEA_reports.DF.MLselected.csv"))

GSEA_reports.DF.MLselected %>% View()
xls.file <- GSEA_reports.DF.MLselected %>% dplyr::select(report3) %>% as_vector()

# function
read.coregenes <- function(default.path=gsea_report_path,
                           xls.file.in.GSEA_reports=report3,
                           category.name = NAME
                           )

{
  gsea_report_files <- list.files(path=default.path,full.names=FALSE,include.dirs = FALSE,recursive=TRUE, pattern="(gsea_report_for)([[:print:]]+)(\\.xls)")

temp.dir <- gsea_report_files[str_detect(gsea_report_files,pattern=xls.file.in.GSEA_reports)] %>% str_split(pattern="/") %>% unlist() %>% .[1]
print(str_c("temp.dir is ",temp.dir))
# xls.file.name to read core gene list file
xls.file.name <- str_c(category.name,".xls") #%>% str_replace("UP","FC_UP") %>% str_replace("DOWN","FC_DOWN")
# 
core.data <- read_tsv(file.path(default.path,temp.dir,xls.file.name)) %>% mutate(dirname=temp.dir) # actually the xls file is tsv files (found by Julin...) . X10 is blank, so read only nine columns (how to ?)
return(core.data)
}  
```
# using map() or pmap() to add "core" gene list tata to each row of GSEA_reports.DF.all (ended up to use old Loop way...)
```{r}
gsea_report_path=file.path("~","Box","gsea_home","output","oct30")
# loop (though this is not smart R way)
coregenes <-list()
temp <- GSEA_reports.DF.MLselected %>% filter(`FDR q-val`< 0.3)
temp %>% View()
for(i in 1:nrow(temp)) {
  coregenes[[i]] <- read.coregenes(xls.file.in.GSEA_reports=as_vector(temp[i,"report3"]),
                           category.name = as_vector(temp[i,grep("MSigDB",names(temp),value=TRUE)]))
} 
names(coregenes) <- str_c(temp$tissue,"_tissue.",temp$NAME) # error fixed (temp$voom.module did not work)

# select genes with "yes" in enrichment
coregenes.yes <- list()
for(i in 1:nrow(temp)) {
  coregenes.yes[[i]] <- coregenes[[i]] %>% filter(`CORE ENRICHMENT`=="Yes") %>% dplyr::select(PROBE) %>% mutate(presence=as.numeric(1))
}
names(coregenes.yes) <- names(coregenes)
# combine (different length of column)
temp2 <- Br.v3.0anno.At.BLAST.highscore %>% dplyr::select(name,AGI,At_symbol, At_full_name,At_short_description) %>% left_join(coregenes.yes[[1]], by=c("name"="PROBE"))
for(i in 2:length(names(coregenes.yes))) {
temp2 <- temp2 %>% left_join(coregenes.yes[[i]], by=c("name"="PROBE"))
}
temp2 %>% View()
#
colnames(temp2)[str_detect(colnames(temp2),"presence")] <- names(coregenes.yes)
coregenes.yes.DF <- temp2
coregenes.yes.DF %>% View()
# replcae NA into 0 (only present/abset info)
coregenes.yes.DF[,-5:-1][is.na(coregenes.yes.DF[,-5:-1])] <- 0
# check
coregenes.yes.DF %>% View()
# write csv
write_csv(coregenes.yes.DF,file=file.path("RNA/output/core_enrichment_genes.csv"))
```

# 

# meaning of sign of cor (test with modTraitRP2.root.voom1[["combined"]] for voom_expression.e1and3.resid.exp_only.root) (090220)
```{r}

combined.longer <- modTraitRP2.root.voom1[["combined"]] %>% 
  pivot_longer(cols=MEbisque4:MEyellowgreen,names_to="modules",values_to="Module Eigengenes") %>% mutate(rowname=factor(rowname,levels=modTraitRP2.root.voom1[["combined"]]$rowname[order(modTraitRP2.root.voom1[["combined"]]$leaf_avg_std)]))
### combine all for some reasons does not work.. [["P"]] is not data.frame.
P.longer <- modTraitRP2.root.voom1[["P"]] %>% as_tibble(rownames=NA) %>% rownames_to_column() %>% dplyr::select(rowname,leaf_avg_std)  %>% filter(rowname!="leaf_avg_std") %>% rename(modules=rowname) %>%  rename(p=leaf_avg_std) %>% mutate(p=round(p,3)) 
PR.longer <- modTraitRP2.root.voom1[["R"]] %>% as_tibble(rownames=NA) %>% rownames_to_column() %>% dplyr::select(rowname,leaf_avg_std)  %>% filter(rowname!="leaf_avg_std") %>% rename(modules=rowname) %>%  rename(r=leaf_avg_std) %>% mutate(r=round(r,3)) %>% inner_join(P.longer, by="modules") %>% mutate(modules.r.p=str_c(modules,"\n",r," (",p,")")) 
PR.longer <- PR.longer %>%  mutate(modules.r.p=factor(modules.r.p,levels=PR.longer[order(PR.longer$r),]$modules.r.p) )
# plot
q <- PR.longer  %>%  inner_join(combined.longer, by="modules") %>% ggplot(aes(x=leaf_avg_std,y=`Module Eigengenes`,color=modules)) + geom_point() + theme(axis.text.x=element_text(angle=90),legend.position = "none") + facet_wrap(~modules.r.p,ncol=11,scales="free")
# 
#ggsave(q,filename=file.path("..","output","voom_expression.e1and3.resid.exp_only.root.leaf_avg_std.VS.ME.plot.png"),height=20,width=8)
ggsave(q,filename=file.path("..","output","voom_expression.e1and3.resid.exp_only.root.leaf_avg_std.VS.ME.plot2.png"),height=8,width=20)

```

# Gene relationship to trait and important modules: Gene Significance and Module Membership (see section 3b in "FemaleLiver-03-relateModsToExt.pdf" in WGCNA_2019 folder) and 3c "
```{r}
load(file.path("..","output","voom_expression.e1and3.resid.exp_only.root.WGCNA.softthresh10.RData"))
modTraitRP2.root.voom1[["combined"]]

MEs <- modTraitRP2.root.voom1[["combined"]] %>% dplyr::select(-leaf_avg_std)
nSamples <- ncol(modTraitRP2.root.voom1[["combined"]]) #%>% dplyr::select(-rowname)

voom.data <- root.voom1

datExpr <- t(voom.data[,-1]) 
colnames(datExpr) <- voom.data$genes
rownames(datExpr) <- colnames(voom.data)[-1]

dim(datExpr);dim(MEs)

geneModuleMembership = as.data.frame(cor(datExpr, MEs[,-1], use = "p"));
MMPvalue = as.data.frame(corPvalueStudent(as.matrix(geneModuleMembership), nSamples));

#names(geneModuleMembership) = paste("MM", modNames, sep="");
#names(MMPvalue) = paste("p.MM", modNames, sep="");
geneTraitSignificance = as.data.frame(cor(datExpr, modTraitRP2.root.voom1[["combined"]][,"leaf_avg_std"], use = "p"));

#geneTraitSignificance = modTraitRP2.root.voom1[["combined"]] %>% dplyr::select(-rowname)
# 
GSPvalue = as.data.frame(corPvalueStudent(as.matrix(geneTraitSignificance), nSamples));
# names(geneTraitSignificance) = paste("GS.", names(weight), sep="");
# names(GSPvalue) = paste("p.GS.", names(weight), sep="");

##
module = "thistle2"
modNames = colnames(geneModuleMembership)
column = match(paste("ME",module,sep=""), modNames); column
moduleGenes = dynamicColors == module

table(moduleGenes)

#sizeGrWindow(7, 7);
#par(mfrow = c(1,1));
verboseScatterplot(abs(geneModuleMembership[moduleGenes, column]),
abs(geneTraitSignificance[moduleGenes, 1]),
                 xlab = paste("Module Membership in", module, "module"),
                 ylab = "Gene significance for leaf_avg_std",
                 main = paste("Module membership vs. gene significance\n"),
                 cex.main = 1.2, cex.lab = 1.2, cex.axis = 1.2, col = module)
```

# writing more general version with ggplot
```{r}
load(file.path("..","output","voom_expression.e1and3.resid.exp_only.root.WGCNA.softthresh10.RData"))
modTraitRP2.root.voom1[["combined"]]

MEs <- modTraitRP2.root.voom1[["combined"]] %>% dplyr::select(-leaf_avg_std)
nSamples <- ncol(modTraitRP2.root.voom1[["combined"]]) #%>% dplyr::select(-rowname)

voom.data <- root.voom1

datExpr <- t(voom.data[,-1]) 
colnames(datExpr) <- voom.data$genes
rownames(datExpr) <- colnames(voom.data)[-1]

dim(datExpr);dim(MEs)

geneModuleMembership = as.data.frame(cor(datExpr, MEs[,-1], use = "p"));
MMPvalue = as.data.frame(corPvalueStudent(as.matrix(geneModuleMembership), nSamples));

#names(geneModuleMembership) = paste("MM", modNames, sep="");
#names(MMPvalue) = paste("p.MM", modNames, sep="");
geneTraitSignificance = as.data.frame(cor(datExpr, modTraitRP2.root.voom1[["combined"]][,"leaf_avg_std"], use = "p"));

#geneTraitSignificance = modTraitRP2.root.voom1[["combined"]] %>% dplyr::select(-rowname)
# 
GSPvalue = as.data.frame(corPvalueStudent(as.matrix(geneTraitSignificance), nSamples));
# names(geneTraitSignificance) = paste("GS.", names(weight), sep="");
# names(GSPvalue) = paste("p.GS.", names(weight), sep="");

##
module = "thistle2"
modNames = colnames(geneModuleMembership)
column = match(paste("ME",module,sep=""), modNames); column
moduleGenes = dynamicColors == module

table(moduleGenes)
#####
geneTraitSignificance %>% head()
# https://stackoverflow.com/questions/28100780/use-with-replacement-functions-like-colnames/28100903
geneTraitSignificance <- geneTraitSignificance %>% magrittr::set_names("GS") %>% rownames_to_column() #%>% head()
length(dynamicColors);dim(geneModuleMembership)

MM.GM <- geneModuleMembership %>% rownames_to_column()  %>% mutate(modules=dynamicColors) %>% pivot_longer(-c(rowname,modules),names_to="ME",values_to="MM") %>% left_join(geneTraitSignificance,by="rowname") %>% mutate(MM.abs=abs(MM),GS.abs=abs(GS))

MM.GM.withinmodule <- MM.GM %>% mutate(ME=str_remove(ME,"ME")) %>% filter(modules==ME)

MM.GM.withinmodule.PR <- PR.longer %>% mutate(modules=str_remove(modules,"ME")) %>% mutate(modules.r.p=factor(modules.r.p,levels=PR.longer[order(PR.longer$r),]$modules.r.p) ) %>% inner_join(MM.GM.withinmodule,by="modules")

temp.p <- MM.GM.withinmodule.PR %>% ggplot(aes(x=MM.abs,y=GS.abs,color=modules)) + geom_point(aes(alpha=0.3)) + theme(legend.position = "none") + facet_wrap(.~modules.r.p,ncol=4,scale="free") 
ggsave(filename="MM.GM.root.voom1.png",path=file.path("..","output"),plot=temp.p,height=20,width=8)
```

#  module eigengene vs expression (within module vs outside module)
```{r}
# extract module eigengenes in a given module
modTraitRP2.root.voom1[["combined"]]
root.voom1.mod3 <- root.voom1 %>% mutate(dat.voom.module=dynamicColors)

# save objects for working on the function below
save(modTraitRP2.root.voom1,root.voom1.mod3, file=file.path("..","output","data.for.expression.module.Rdata"))

# 
load(file.path("..","output","data.for.expression.module.Rdata"))
mod = "thistle2"
expression.module <- function(target.module=mod,dat.voom=root.voom1.mod3,modTraitRP2=modTraitRP2.root.voom1) {
  print(str_c("The target.module is ",target.module,"."))
  # add withi/outside of target.module info
dat.voom <- dat.voom %>% mutate(TF=ifelse(dat.voom.module==target.module,"within the module","not in the module"),.keep="unused")
# longer format
dat.voom.long <- dat.voom %>% pivot_longer(-c(genes,TF),names_to="rowname",values_to="value") 
# making levels to sort samples according to module eigengenes
sample.levels <- modTraitRP2[["combined"]] %>% dplyr::select(rowname,str_c("ME",target.module)) %>% arrange_at(.vars=2) %>% dplyr::select(rowname) %>% as_vector()
# add expression data
dat.voom.ME <- modTraitRP2[["combined"]] %>% dplyr::select(rowname,str_c("ME",target.module))  %>% inner_join(dat.voom.long,by="rowname") %>%
  arrange_at(.vars=c(2,4)) %>% mutate(rowname=factor(rowname,levels=sample.levels))
# number of genes in each sample
# dat.voom.mod3.ME   %>% group_by(rowname) %>% summarize(n())


# plot
p.TF <- dat.voom.ME  %>%  ggplot(aes(x=rowname,y=value,color=TF,group=genes)) + geom_line(alpha=0.1) + theme(axis.text.x=element_text(angle=90),legend.position="none") + facet_grid(.~TF) + labs(title=target.module)
#p.TF2 <- dat.voom.mod3.ME  %>%  ggplot(aes(x=MEthistle2,y=value,color=TF,group=genes)) + geom_line(alpha=0.1) + geom_point(alpha=0.1) + theme(axis.text.x=element_text(angle=90),legend.position="none") + facet_grid(.~TF) + labs(title=target.module) # works only for MEthistle2

# p.TF3 <- dat.voom.mod3.ME  %>%  ggplot(aes(x=str_c("ME",target.module),y=value,color=TF,group=genes)) + geom_line(alpha=0.1) + geom_point(alpha=0.1) + theme(axis.text.x=element_text(angle=90),legend.position="none") + facet_grid(.~TF) + labs(title=target.module) # str_c("ME",target.module) does not work I expected
dat.voom.ME.1 <- dat.voom.ME  %>%  filter(TF=="within the module")

p.TF4 <- dat.voom.ME.1 %>% ggplot(aes(x=rowname,y=value,color=TF,group=genes)) + geom_line(alpha=0.1) +  theme(axis.text.x=element_text(angle=90),legend.position="none")  + labs(title=target.module)
#p.TF5 <- p.TF4  + geom_line(aes(x=rowname,y=MEthistle2),color="black",size=1) # works only MEthistle2
# https://ggplot2.tidyverse.org/reference/aes_.html
# p.TF4  + geom_line(aes_string(x="rowname",y=str_c("ME",target.module)),color="blue",size=1) #works
#p.TF4  + geom_line(aes_(x=~rowname,y=str_c("ME",target.module)),color="blue",size=1) # error

# because
#aes_string(data=dat.voom.mod3.ME.1,x="rowname",y=str_c("ME",target.module))
#aes_(data=quote(dat.voom.mod3.ME.1),x=quote(rowname),y=str_c("ME",target.module))
#aes_(data=~dat.voom.mod3.ME.1,x=~rowname,y=str_c("ME",target.module))

# but aes_() will be soft deprecated, so that need to use quasiquotation (!!, !!!, :=)  (https://www.tidyverse.org/blog/2018/07/ggplot2-tidy-evaluation/)
# https://adv-r.hadley.nz/quasiquotation.html
#rowname <- enquo(rowname)
# MEtarget.module <- enquo(str_c("ME",target.module))
# MEtarget.module <- !!str_c("ME",target.module)
print(dat.voom.ME.1)

MEtarget.module <- str_c("ME",target.module)
print(MEtarget.module)
y <- enquo(MEtarget.module)
print(y)

#p.TF5 <- p.TF4  + geom_line(aes(x=rowname,y=!!str_c("ME",target.module)),color="blue",size=1)
#p.TF5 <- p.TF4  + geom_line(aes(x=rowname,y:=str_c("ME",target.module)),color="blue",size=1)
#p.TF5 <- p.TF4  + geom_line(aes(x=rowname,y=!!MEtarget.module),color="blue",size=1)
#p.TF5 <- p.TF4  + geom_line(aes(x=rowname,y=!!y),color="blue",size=1)
#p.TF5 <- p.TF4  + geom_line(aes(x=rowname,y=!!y))
p.TF5 <- p.TF4  + geom_line(aes(x=rowname,y=y))
# test
p.TF6 <- dat.voom.ME.1 %>% ggplot(aes(x=rowname,y=quote(y),color=TF,group=genes)) + geom_line(alpha=0.1) +  theme(axis.text.x=element_text(angle=90),legend.position="none")  + labs(title=target.module)

# different solution
# remove "ME" from colunm name
dat.voom.ME.1 <- dat.voom.ME.1 %>% rename_with(~gsub("ME","",.x),starts_with("ME"))
#
yy <- enquo(target.module)
yy
#yyy <- !!yy #Error: Quosures can only be unquoted within a quasiquotation context.)
#yyy
#p.TF7 <- dat.voom.ME.1 %>% ggplot(aes(x=rowname,y={{ target.module }},color=TF,group=genes)) + geom_line(alpha=0.1) +  theme(axis.text.x=element_text(angle=90),legend.position="none")  + labs(title=target.module)
p.TF7 <- dat.voom.ME.1 %>% ggplot(aes(x=rowname,y=target.module,color=TF,group=genes)) + geom_line(alpha=0.1) +  theme(axis.text.x=element_text(angle=90),legend.position="none")  + labs(title=target.module)
return(p.TF5)
}

```


# 
```{r}
expression.module2 <- function(target.module=mod,dat.voom=root.voom1.mod3,modTraitRP2=modTraitRP2.root.voom1) {
  print(str_c("The target.module is ",target.module,"."))
  # add withi/outside of target.module info
dat.voom <- dat.voom %>% mutate(TF=ifelse(dat.voom.module==target.module,"within the module","not in the module"),.keep="unused")
# longer format
dat.voom.long <- dat.voom %>% pivot_longer(-c(genes,TF),names_to="rowname",values_to="value") 
# making levels to sort samples according to module eigengenes
sample.levels <- modTraitRP2[["combined"]] %>% dplyr::select(rowname,str_c("ME",target.module)) %>% arrange_at(.vars=2) %>% dplyr::select(rowname) %>% as_vector()
# add expression data
dat.voom.ME <- modTraitRP2[["combined"]] %>% dplyr::select(rowname,str_c("ME",target.module))  %>% inner_join(dat.voom.long,by="rowname") %>%
  arrange_at(.vars=c(2,4)) %>% mutate(rowname=factor(rowname,levels=sample.levels))
# plot (only "within the module")
dat.voom.ME.1 <- dat.voom.ME  %>%  filter(TF=="within the module")
print(dat.voom.ME.1)
p.TF4 <- dat.voom.ME.1 %>% ggplot(aes(x=rowname,y=value,color=TF,group=genes)) + geom_line(alpha=0.1) +  theme(axis.text.x=element_text(angle=90),legend.position="none")  + labs(title=target.module)
# https://ggplot2.tidyverse.org/reference/aes_.html
p.TF5 <- p.TF4  + geom_line(aes_string(x="rowname",y=str_c("ME",target.module)),color="blue",size=1) #works

# but aes_() will be soft deprecated, so that need to use quasiquotation (!!, !!!, :=)  (https://www.tidyverse.org/blog/2018/07/ggplot2-tidy-evaluation/)
# https://adv-r.hadley.nz/quasiquotation.html
print(dat.voom.ME.1)


# different solution
# remove "ME" from colunm name
dat.voom.ME.2 <- dat.voom.ME.1 %>% rename_with(~gsub("ME","",.x),starts_with("ME"))
print("dat.voom.ME.2")
print(dat.voom.ME.2)
# works only for "bisque4" with aes_string()
p.TF7 <- dat.voom.ME.2 %>%  ggplot(aes(x=rowname,y=value,color=TF,group=genes)) + geom_line(alpha=0.1)  + geom_point(aes_string(x="rowname",y="bisque4"),color="black",size=1) +  theme(axis.text.x=element_text(angle=90),legend.position="none")  + labs(title=target.module)

p.TF8 <- dat.voom.ME.2 %>% ggplot() + geom_line(aes_string(x="rowname",y=target.module,group="genes"),color="black",size=1) +  theme(axis.text.x=element_text(angle=90),legend.position="none")  + labs(title=target.module)

p.TF9 <- dat.voom.ME.2 %>% ggplot() + geom_line(aes_string(x="rowname",y=target.module,group="genes"),color="black",size=1) +  theme(axis.text.x=element_text(angle=90),legend.position="none")  + labs(title=target.module) # works
print("aes(x=rowname,y=!!target.module) is");print(aes(x=rowname,y=!!target.module))
p.TF10 <- dat.voom.ME.2 %>% ggplot(aes(x=rowname,y=value,color=TF,group=genes)) + geom_line(alpha=0.1) + geom_line(aes(x=rowname,y=!!target.module,group="genes"),color="black",size=1) +  theme(axis.text.x=element_text(angle=90),legend.position="none")  + labs(title=target.module)
# 
yy <- enquo(target.module)
yy
print("yy")
print(yy)
p.TF11 <- dat.voom.ME.2 %>% ggplot() + geom_line(aes(x=rowname,y=!!yy,group="genes"),color="black",size=1) +  theme(axis.text.x=element_text(angle=90),legend.position="none")  + labs(title=target.module)

# how about {{}} ? What is it?
p.TF12 <- dat.voom.ME.2 %>% ggplot() + geom_line(aes(x=rowname,y={{target.module}},group="genes"),color="black",size=1) +  theme(axis.text.x=element_text(angle=90),legend.position="none")  + labs(title=target.module)

return(p.TF10)
}

```


# test the function
```{r}
# 1
mod = "bisque4"
expression.module2(target.module=mod,dat.voom=root.voom1.mod3,modTraitRP2=modTraitRP2.root.voom1)
# 2
expression.module2(target.module=mod,dat.voom=root.voom1.mod3,modTraitRP2=modTraitRP2.root.voom1)
# 3
mod = as.name("bisque4") # works see example in aes() https://ggplot2.tidyverse.org/reference/aes_.html
expression.module2(target.module=a,dat.voom=root.voom1.mod3,modTraitRP2=modTraitRP2.root.voom1) #p.TF10

```

# all modules
```{r}
plot.list <- tibble(dynamicColors=names(table(dynamicColors))) %>% split(.$dynamicColors) %>% map(~expression.module(target.module=.$dynamicColors,dat.voom=root.voom1,modTraitRP2=modTraitRP2.root.voom1))

# save(plot.list,file=file.path("..","output","root.voom1.plot.list.Rdata")) # 1.62 GB too big.

p <- plot.list[[49]] + 
ggsave(p,path=file.path("..","output"),filename="root.voom1.plot.list.thistle2.png")
ggsave(p,path=file.path("..","output"),filename="root.voom1.plot.list.thistle2.pdf")

ggsave(p.TF5,path=file.path("..","output"),filename="root.voom1.plot.list.thistle2.png")

save(p,file=file.path("..","output","root.voom1.plot.list.thistle2.Rdata")) # 
```

# all modules with only target module
```{r}
plot.list2 <- tibble(dynamicColors=names(table(dynamicColors))) %>% split(.$dynamicColors) %>% map(~expression.module2(target.module=as.name(.$dynamicColors),dat.voom=root.voom1.mod3,modTraitRP2=modTraitRP2.root.voom1)) # work????
plot.list2[[1]];plot.list2[[2]]


```

